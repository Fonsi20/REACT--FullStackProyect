var fs = require('fs');
var path = require('path');
var mkdirp = require('mkdirp');
var express = require('express');

var Backdrop = module.exports = function(_config) {
  var getStatus = function(url) {
    var file = getFilePath(url + '.code');
    if(fs.existsSync(file)) {
      return fs.readFileSync(file).toString();
    } else {
      return false;
    }
  };

  var initAppServer = function() {
    var app = express();
    app.get('*', function(req, res) {
      var jsonFile = getFilePath(req.url + '.json');
      var statusCode = getStatus(req.url);
      var json = '';
      if(fs.existsSync(jsonFile)) {
        json = fs.readFileSync(jsonFile).toString();
        statusCode = statusCode || '200';
      } else {
        statusCode = statusCode || '404';
      }
      res.status(parseInt(statusCode)).send(json);
    });
    return app;
  };

  var getFilePath = function(route) {
    return path.join('tmp', 'backdrop', route);
  };

  this.app = initAppServer();

  Backdrop.prototype.load = function(json, route) {
    var file = getFilePath(route + '.json');
    mkdirp.sync(path.dirname(file));
    fs.writeFileSync(file, JSON.stringify(json));
  };

  Backdrop.prototype.status = function(code, route) {
    var file = getFilePath(route + '.code');
    mkdirp.sync(path.dirname(file));
    fs.writeFileSync(file, code);
  };
};
